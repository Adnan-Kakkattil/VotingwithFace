{% extends "base.html" %}
{% block title %}{{ election.title }} - Admin{% endblock %}
{% block content %}
<nav class="mb-3">
    <a href="{{ url_for('admin.elections_list') }}" class="text-muted">← Elections</a>
</nav>
<h2 class="mb-2">{{ election.title }}</h2>
<p class="text-muted mb-4">{{ election.description or 'No description' }}</p>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Status</h6>
                {% if election.is_ongoing %}<span class="badge bg-success">Ongoing</span>
                {% elif election.is_upcoming %}<span class="badge bg-info">Upcoming</span>
                {% else %}<span class="badge bg-secondary">Completed</span>{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Period</h6>
                {{ election.start_date.strftime('%b %d, %Y') }} – {{ election.end_date.strftime('%b %d, %Y') }}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Total Votes</h6>
                {{ election.votes.count() }}
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-header">Candidates</div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.add_candidate_to_election', eid=election.id) }}" class="border rounded p-3 mb-3 bg-light-subtle">
            <h6 class="mb-3">Add Candidate</h6>
            <div class="row g-2">
                <div class="col-md-5">
                    <label for="user_id" class="form-label">Student</label>
                    <select class="form-select" id="user_id" name="user_id" required>
                        <option value="">Select student</option>
                        {% for s in available_students %}
                        <option value="{{ s.id }}">{{ s.name }} ({{ s.email }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="approved" selected>approved</option>
                        <option value="pending">pending</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="manifesto" class="form-label">Manifesto (optional)</label>
                    <input type="text" class="form-control" id="manifesto" name="manifesto" maxlength="300" placeholder="Short manifesto">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Add Candidate</button>
                {% if not available_students %}
                <span class="text-muted ms-2">All students are already candidates in this election.</span>
                {% endif %}
            </div>
        </form>

        {% if candidates %}
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Votes</th>
                    <th>Nominated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for c in candidates %}
                <tr>
                    <td>{{ c.user.name }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if c.status=='approved' else 'warning' if c.status=='pending' else 'secondary' }}">
                            {{ c.status }}
                        </span>
                    </td>
                    <td>{{ c.vote_count }}</td>
                    <td>{{ c.nominated_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if c.status == 'pending' %}
                        <form action="{{ url_for('admin.approve_candidate', cid=c.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-success">Approve</button>
                        </form>
                        <form action="{{ url_for('admin.reject_candidate', cid=c.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Reject</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted mb-0">No candidates yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
