{% extends "base.html" %}
{% block title %}Register Face - College Voting{% endblock %}
{% block content %}
<h2 class="mb-4"><i class="bi bi-image me-2"></i>Register Your Face</h2>
<div class="card">
    <div class="card-body">
        <p class="text-muted">Upload a clear photo of your face. Ensure good lighting and only one person is visible.</p>
        <div class="row">
            <div class="col-md-6">
                <label for="faceImage" class="form-label">Face image</label>
                <input
                    type="file"
                    id="faceImage"
                    class="form-control"
                    accept="image/*"
                >
                <div class="small text-muted mt-2">Accepted: JPG, PNG, WEBP (single face only).</div>
                <div class="border rounded overflow-hidden bg-light mt-3 d-none" id="previewContainer" style="aspect-ratio:4/3;">
                    <img id="previewImg" src="" alt="Selected face image" style="width:100%;height:100%;object-fit:cover;">
                </div>
                <div class="mt-2 d-flex gap-2">
                    <button id="captureBtn" class="btn btn-primary">
                        <i class="bi bi-check2-circle me-1"></i>Upload & Register
                    </button>
                    <a href="{{ url_for('student.dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
            <div class="col-md-6">
                <div id="status" class="alert alert-info">Choose an image and click "Upload & Register" to register your face.</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    const faceImageInput = document.getElementById('faceImage');
    const previewContainer = document.getElementById('previewContainer');
    const previewImg = document.getElementById('previewImg');
    const captureBtn = document.getElementById('captureBtn');
    const status = document.getElementById('status');

    async function register() {
        const selectedFile = faceImageInput.files && faceImageInput.files[0];
        if (!selectedFile) {
            status.className = 'alert alert-warning';
            status.textContent = 'Please choose an image first.';
            return;
        }
        captureBtn.disabled = true;
        status.className = 'alert alert-info';
        status.textContent = 'Registering... (this may take 10â€“30 seconds)';
        try {
            const formData = new FormData();
            formData.append('image', selectedFile);
            const r = await fetch('{{ url_for("face_api.register_face") }}', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            let data;
            try {
                data = await r.json();
            } catch (parseErr) {
                const text = await r.text();
                throw new Error('Server error: ' + (r.status || '') + ' ' + (text.slice(0, 100) || 'Invalid response'));
            }
            if (data.success) {
                status.className = 'alert alert-success';
                status.textContent = 'Face registered successfully! Redirecting...';
                setTimeout(() => window.location.href = '{{ url_for("student.dashboard") }}', 1500);
            } else {
                status.className = 'alert alert-danger';
                status.textContent = data.error || 'Registration failed.';
                captureBtn.disabled = false;
            }
        } catch (e) {
            status.className = 'alert alert-danger';
            status.textContent = e.message || 'Network error. Try again.';
            captureBtn.disabled = false;
        }
    }

    faceImageInput.addEventListener('change', () => {
        const selectedFile = faceImageInput.files && faceImageInput.files[0];
        if (!selectedFile) {
            previewContainer.classList.add('d-none');
            previewImg.src = '';
            return;
        }
        previewImg.src = URL.createObjectURL(selectedFile);
        previewContainer.classList.remove('d-none');
    });

    captureBtn.addEventListener('click', async () => {
        await register();
    });
})();
</script>
{% endblock %}
